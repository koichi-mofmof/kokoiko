# ClippyMap テスト計画

## 🔴 最優先テスト

- [x] テスト環境のセットアップ
  - [x] Jest + React Testing Library インストール
  - [x] Jest の設定ファイル作成
  - [x] MSW (Mock Service Worker) セットアップ
  - [x] Supabase モックの準備
  - [x] テスト実行用の npm スクリプト追加

## 🟡 テスト進捗状況

### コア機能テスト

- **認証機能テスト**: 9/9 ✅ (100%)
- **UI コンポーネントテスト**: 16/26 🟨 (62%)
- **アクセシビリティテスト**: 5/6 🟨 (83%)
- **パフォーマンステスト**: 2/2 ✅ (100%)
- **統合テスト**: 8/15 🟡 (53%)
- **全体コードカバレッジ**: 約 27% 🔴

### 最近の主な進展

- キーボードナビゲーションテスト完了
- アクセシビリティ問題の検出と修正
- ProfileSettings コンポーネントのアクセシビリティ改善
- サーバーコンポーネントとの連携テスト
- PlaceList と SearchableSampleList のテスト実装

### 残りの主要課題

- スクリーンリーダー互換性テスト
- データフェッチングのテスト
- モバイル対応のテスト
- サーバーアクションとの連携テスト

## 🟡 認証機能テスト

- [x] 単体テスト: ログアウト機能

  - [x] logoutUser 関数のテスト (auth.ts)
    - [x] Supabase signOut 関数呼び出しの確認
    - [x] リダイレクト処理の確認
    - [x] revalidatePath 動作確認

- [x] 単体テスト: ログイン機能
  - [x] loginWithCredentials 関数のテスト
    - [x] 有効な認証情報でのログイン成功
    - [x] 無効な認証情報でのエラー処理
    - [x] 入力バリデーションのテスト
- [x] 単体テスト: サインアップ機能
  - [x] signupWithCredentials 関数のテスト
    - [x] 有効なデータでのサインアップ成功
    - [x] 既存ユーザーの重複チェック
    - [x] パスワード要件バリデーション
    - [x] 利用規約同意チェックのバリデーション

## 🟢 UI コンポーネントテスト

- [x] Header コンポーネントテスト (Header.tsx)

  - [x] 未ログイン状態の表示確認
  - [x] ログイン状態の表示確認
  - [x] プロフィール画像表示のテスト
  - [x] ログアウトボタンクリック時のフォーム送信確認

- [x] ProfileSettings コンポーネントテスト (profile-settings.tsx)

  - [x] 初期データ表示のテスト
  - [x] フォーム入力とバリデーションテスト
  - [x] 画像アップロード処理のテスト
  - [x] フォーム送信処理のテスト
  - [x] エラー表示のテスト

- [~] ログインフォームコンポーネントテスト (login-form.tsx)
  - [~] フォーム表示と入力テスト
  - [~] バリデーションエラー表示のテスト
  - [~] パスワード表示/非表示切り替えのテスト
  - [~] Google ログインボタンのテスト
  - [!] Server Actions と React hooks の干渉によりテストが複雑化

## 🔵 追加テスト (余裕があれば実装)

- [x] 場所一覧表示テスト (PlaceList.tsx)

  - [x] リスト表示確認（場所名、住所、メモ、タグ等の表示）
  - [x] 場所選択イベント発火確認
  - [x] 選択された場所の強調表示確認
  - [x] 空リスト表示確認
  - [x] フィルタリング動作確認
    - [x] キーワード検索フィルター
    - [x] タグフィルター
    - [x] 訪問状況フィルター
    - [x] 複数フィルターの組み合わせ
  - [x] 並び替え機能確認
    - [x] 名前順の並び替え
    - [x] 住所順の並び替え
    - [x] 日付順の並び替え

- [x] サンプルリスト検索コンポーネントテスト (SearchableSampleList.tsx)
  - [x] 検索入力フィールド表示確認
  - [x] 全リストの初期表示確認
  - [x] 検索フィルタリング動作確認
  - [x] 検索結果 0 件時のメッセージ表示確認
  - [x] 検索クリア時の全リスト再表示確認

## 備考

- テストカバレッジは機能的な側面を重視し、UI の細かな部分よりもユーザーフローを優先する
- モックデータは実際のデータ構造に近いものを使用すること
- 非同期処理のテストにはタイムアウト設定に注意（特に Google Maps API 関連）

## 🟠 結合テスト

- [x] 認証フロー結合テスト

  - [x] ログインからログアウトまでの一連のフロー
  - [x] ログイン後の状態変化確認
  - [x] ログアウト後の状態変化確認

- [x] プロフィール管理フロー結合テスト

  - [x] プロフィール情報取得と表示
  - [x] プロフィール情報更新フロー
  - [x] プロフィール画像アップロードフロー
  - [x] 更新後のヘッダー表示反映確認

- [x] サンプル画面フロー結合テスト
  - [x] リスト一覧から詳細画面への遷移フロー
  - [x] 詳細画面から一覧への戻るフロー
  - [x] 非ログイン状態でのアクセス制限確認
  - [x] フィルター適用からマップ表示切替フロー

## 🟢 リスト機能テスト

- [x] リスト作成機能テスト

  - [x] 単体テスト: リスト作成アクション
  - [x] 有効なデータでのリスト作成成功
  - [x] 必須フィールド未入力時のバリデーション
  - [x] リスト作成後のリダイレクト処理
  - [x] エラーハンドリングのテスト
  - [x] CreateListModal コンポーネントテスト
  - [x] モーダル表示・非表示の切り替え
  - [x] フォーム要素の表示確認
  - [x] バリデーションメッセージの表示
  - [x] 作成ボタンクリック時のアクション発火確認
  - [x] キャンセル処理の確認
  - [x] ListFormComponent テスト
  - [x] 初期状態の確認
  - [x] 入力フィールドの操作テスト
  - [x] バリデーションエラー表示
  - [x] 送信処理のテスト

- [x] リスト編集機能テスト

  - [x] 単体テスト: リスト更新アクション
  - [x] 有効なデータでのリスト更新成功
  - [x] 無効なリスト ID でのエラー処理
  - [x] 権限チェックのテスト
  - [x] 更新後のデータ反映確認
  - [x] EditListDialog コンポーネントテスト
  - [x] ダイアログ表示・非表示の切り替え
  - [x] 既存データの初期表示
  - [x] フォーム入力と送信テスト
  - [x] キャンセルボタンのテスト
  - [x] エラー表示のテスト

- [x] リスト削除機能テスト

  - [x] 単体テスト: リスト削除アクション
  - [x] リスト削除成功確認
  - [x] 削除権限のチェック
  - [x] 無効なリスト ID でのエラー処理
  - [x] 関連データの削除確認（カスケード削除）
  - [x] DeleteListDialog コンポーネントテスト
  - [x] 削除確認ダイアログの表示
  - [x] 警告メッセージの確認
  - [x] 削除実行時のアクション発火確認
  - [x] キャンセルボタンのテスト

- [x] リスト表示機能テスト

  - [x] MyLists コンポーネントテスト
  - [x] リスト一覧の表示確認
  - [x] 空リスト時の表示確認
  - [x] リストカード表示内容の確認（タイトル、説明、作成日など）
  - [x] リストカードクリック時の遷移確認
  - [x] ListCardActions コンポーネントテスト
  - [x] アクションメニューの表示
  - [x] 各アクションボタンの表示確認（編集、削除、共有など）
  - [x] ボタンクリック時のイベント発火確認
  - [x] 権限による表示制御テスト

- [x] アクセシビリティテスト (リスト機能)
  - [x] CreateListModal のアクセシビリティテスト
  - [x] EditListDialog のアクセシビリティテスト
  - [x] DeleteListDialog のアクセシビリティテスト
  - [x] キーボードナビゲーション対応確認

## 🟠 リスト機能結合テスト

- [x] リスト作成から削除までのワークフロー

  - [x] 新規リスト作成からリスト詳細表示までのフロー
  - [x] リスト編集と更新反映の確認
  - [x] リスト削除と一覧からの削除確認

- [x] リスト共有フロー

  - [x] リスト共有設定フロー
  - [x] 共有ユーザーのアクセス確認
  - [x] 権限設定の反映確認

- [x] エラー状態のハンドリング
  - [x] ネットワークエラー時の挙動
  - [x] サーバーエラー時のフィードバック
  - [x] バリデーションエラーのユーザーフィードバック

## ⚪ 拡張テスト・改善

- [x] テストカバレッジの測定と報告

  - [x] Jest カバレッジレポート設定
  - [x] CI/CD パイプラインへの統合
  - [ ] カバレッジ目標設定（80%以上）

- [x] パフォーマンステスト

  - [x] コンポーネントレンダリング時間測定
    - [x] ProfileSettings コンポーネント計測
    - [x] PlaceList コンポーネント計測（データ量による比較）
  - [x] メモリリーク検出
    - [x] 連続レンダリングでのメモリ使用量測定
  - [ ] 画像表示最適化の検証

- [x] アクセシビリティテスト
  - [x] axe-core を使用した a11y テスト
    - [x] ProfileSettings コンポーネント評価
    - [x] PlaceList コンポーネント評価
  - [x] キーボードナビゲーションテスト
    - [x] フォーカス可能要素の確認
  - [ ] スクリーンリーダー互換性テスト

## 📝 テスト実装のベストプラクティス

- [x] モック戦略の確立

  - [x] Supabase クライアントのモック方法標準化
  - [ ] Storage モックの標準化
  - [x] 認証状態のモック方法確立
  - [ ] 地図 API のモック方法標準化

- [~] テストユーティリティ関数の作成

  - [ ] 認証済みユーザーレンダリングヘルパー
  - [ ] フォーム入力ヘルパー
  - [ ] カスタムマッチャー
  - [ ] 地図コンポーネントレンダリングヘルパー

- [x] テストデータの準備
  - [x] テスト用ユーザーデータ
  - [ ] テスト用プロフィールデータ
  - [ ] テスト用画像ファイル
  - [x] テスト用場所・リストデータ

## 📚 学習リソース

- [x] Jest 公式ドキュメント確認
- [x] React Testing Library 活用ガイド確認
- [x] MSW を使った API モックの学習
- [x] Next.js のテストに関する公式ガイド確認
- [ ] 地図コンポーネントのテスト手法調査

## 🚧 現在の課題と対応

- [!] Next.js の Server Actions をテスト環境で正しくモックすることが難しい
  - 解決策: logoutUser 関数のみモック実装、他はオリジナル関数を使用
- [!] React の useActionState など特定のフックのモックが複雑
  - 解決策: 当面は UI コンポーネントテストを単純なコンポーネントに集中
- [!] リダイレクト処理を含むテストのハンドリング
  - 解決策: try-catch でリダイレクトエラーをキャッチして無視する

## 📈 テスト進捗

- 認証機能テスト: 100% 完了 (9/9)
- UI コンポーネントテスト: 80% 完了 (21/26)
- リスト機能テスト: 100% 完了 (20/20)
- 追加テスト: 70% 完了 (15/22)
- 統合テスト: 80% 完了 (12/15)
- モック環境整備: 90% 完了
- 全体コードカバレッジ: 45%程度

## 📊 今後のカバレッジ向上戦略

1. 未テスト UI コンポーネントに対する単体テスト作成
2. 認証フローやプロフィール管理フローの結合テスト完了
3. 未実装の追加テスト（特に画像表示最適化とスクリーンリーダー互換性テスト）の追加
4. Server Actions を使用するコンポーネントへの対応方針検討

## 📝 テスト実装の課題と解決策

- ✓ Next.js のリダイレクト処理： `redirect` 関数のモックと例外ハンドリングで解決
- ✓ Supabase 認証関連のテスト： モックで対応完了
- ✓ 重複要素のテスト： クエリセレクタや data-testid 属性の活用で解決
- ✓ UI 要素のモック： Button, Avatar, Icon など汎用コンポーネントのモック化
- ◯ Server Actions との連携： 一部は回避策を実装したが、包括的な解決策の検討が必要
- ◯ 複雑な状態管理を持つコンポーネント： モック戦略の改善が必要

## 📋 最新のアクセシビリティテスト結果

- ✅ ファイルアップロード要素のラベル不足 (解決済み)

  - 問題：ProfileSettings のファイルアップロード用 input 要素にはアクセシブルなラベルがなかった
  - 解決策：aria-label を追加し、適切な label と input の関連付けを実装

- ✅ インタラクティブな要素の入れ子 (解決済み)
  - 問題：ボタン内に配置された別のインタラクティブな要素があった
  - 解決策：ボタンとラベルの構造を見直し、label と input の適切な HTML 構造に修正

### 最新のテスト結果

- ProfileSettings コンポーネント：アクセシビリティ違反 0 件
- PlaceList コンポーネント：アクセシビリティ違反 0 件
- フォーカス可能な要素：4 件 (input: 2, textarea: 1, button: 1)

### 今後の対応

- スクリーンリーダー互換性テストの実装
- 他のコンポーネントに対する同様のアクセシビリティ改善の適用

## 📊 テスト実行結果サマリー

### 最新のアクセシビリティテスト実行結果（2023-12-10）

```
アクセシビリティ違反検出: 0件
重要なアクセシビリティ問題: 0件
PlaceListコンポーネントにアクセシビリティ違反はありません。
PlaceList アクセシビリティ違反検出: 0件
フォーカス可能な要素: 4件
フォーカス可能な要素のタイプ: { input: 2, textarea: 1, button: 1 }
```

### 最新のキーボードナビゲーションテスト結果（2023-12-10）

✅ `ProfileSettingsコンポーネントで基本的なキーボードナビゲーションが可能なこと`  
✅ `PlaceListコンポーネントでキーボード操作が可能なこと`  
✅ `フォーカスインジケーターがキーボード操作で機能すること`

### 最新のパフォーマンステスト結果（2023-12-10）

```
ProfileSettings レンダリング時間: 12.06ms (4.22ms～41.69ms)
PlaceList (10件) レンダリング時間: 17.36ms (15.43ms～18.78ms)
初期メモリ使用量: 112.77MB
20回レンダリング後のメモリ使用量: 143.16MB
レンダリング1回あたりのメモリ増加量: 1.52MB
```
